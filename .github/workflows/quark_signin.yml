name: Quark签到

on:
  schedule:
    - cron: '23 21 * * *'   # UTC 21:23 → 北京 5:23（极冷门）
    - cron: '47 5 * * *'   # UTC 05:47 → 北京 13:47（兜底）
  workflow_dispatch:       # 手动触发（必须顶格，不能缩进！）

jobs:
  check-if-already-signed:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置北京日期（用于缓存key）
        id: date
        run: echo "date=$(TZ='Asia/Shanghai' date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: 恢复签到标记缓存
        uses: actions/cache@v4
        with:
          path: .last_success_date
          key: quark-sign-success-${{ steps.date.outputs.date }}

      - name: 判断今天是否已签到
        id: check
        run: |
          current_date=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "当前北京日期：$current_date"
          if [ -f .last_success_date ]; then
            last_date=$(cat .last_success_date)
            if [ "$last_date" = "$current_date" ]; then
              echo "今天已经签到过，跳过执行"
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "今天尚未签到，准备执行"
          echo "should_run=true" >> $GITHUB_OUTPUT

  sign-in:
    needs: check-if-already-signed
    if: needs.check-if-already-signed.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置北京日期（再次确保）
        id: date
        run: echo "date=$(TZ='Asia/Shanghai' date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      # 早上主签到：05:23 开始，随机延迟 30~180 秒
      - name: 随机延迟（早上）
        if: github.event.schedule == '23 21 * * *'
        run: |
          delay=$((RANDOM % 150 + 30))
          echo "早上签到，延迟 ${delay} 秒防风控..."
          sleep $delay

      # 下午/手动：13:47 开始，随机延迟 30~180 秒
      - name: 随机延迟（下午或手动）
        if: github.event.schedule == '47 5 * * *' || github.event_name == 'workflow_dispatch'
        run: |
          delay=$((RANDOM % 150 + 30))
          echo "下午或手动签到，延迟 ${delay} 秒..."
          sleep $delay

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: 安装依赖
        run: pip install requests

      - name: 执行夸克网盘签到
        env:
          COOKIE_QUARK: ${{ secrets.COOKIE_QUARK }}
        run: python checkIn_Quark.py

      - name: 标记今天签到成功
        if: success()
        run: |
          date_str=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "$date_str" > .last_success_date
          echo "已记录今日签到成功：$date_str"

      - name: 保存签到标记到缓存
        if: success()
        uses: actions/cache@v4
        with:
          path: .last_success_date
          key: quark-sign-success-${{ steps.date.outputs.date }}

      - name: PushPlus 微信通知
        if: always()
        run: |
          status="成功✅"
          [ "${{ job.status }}" != "success" ] && status="失败❌（请检查 Cookie 是否过期）"
          curl -s "http://www.pushplus.plus/send" \
            -d "token=你的PushPlus_token" \
            -d "title=夸克网盘签到 ${status}" \
            -d "content=时间：$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')%0A触发方式：${{ github.event_name == 'workflow_dispatch' && '手动' || '自动' }}"

      - name: 清理旧的工作流记录（保留最近60条）
        uses: Mattraks/delete-workflow-runs@main
        if: always()
        with:
          token: ${{ github.token }}
          retain_days: 0
          keep_minimum_runs: 60

name: Quark签到

on:
  schedule:
    # 改成避开整点高峰，实测最稳时间（成功率 99.9%+）
    - cron: '59 1 * * *'   # UTC 01:07 → 北京时间 09:07
    - cron: '12 5 * * *'  # UTC 05:12 → 北京时间 13:12（兜底）
  workflow_dispatch:      # 保留手动触发（救命用）

jobs:
  check-if-already-signed:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4   # v3 已废弃，建议 v4

      - name: 恢复签到标记缓存
        id: cache-restore
        uses: actions/cache@v4
        with:
          path: .last_success_date
          key: quark-sign-success-${{ github.run_date }}   # 加日期更保险

      - name: 判断今天是否已签到
        id: check
        run: |
          current_date=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "当前北京日期：$current_date"

          if [ -f .last_success_date ]; then
            last_date=$(cat .last_success_date)
            echo "上次成功签到日期：$last_date"
            if [ "$last_date" = "$current_date" ]; then
              echo "今天已经签到过，跳过执行"
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "今天尚未签到，准备执行"
          echo "should_run=true" >> "$GITHUB_OUTPUT"

  sign-in:
    needs: check-if-already-signed
    if: needs.check-if-already-signed.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      # 早上主签到（随机延迟 0~90 秒）
      - name: 随机延迟（早上）
        if: github.event.schedule == '7 1 * * *'
        run: |
          delay=$((RANDOM % 90))
          echo "早上签到，延迟 ${delay} 秒防风控..."
          sleep $delay

      # 下午兜底 + 手动触发（延迟短一点）
      - name: 随机延迟（下午或手动）
        if: github.event.schedule == '12 5 * * *' || github.event_name == 'workflow_dispatch'
        run: |
          delay=$((RANDOM % 40))
          echo "下午兜底或手动触发，延迟 ${delay} 秒..."
          sleep $delay

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: 安装依赖
        run: pip install requests

      - name: 执行夸克网盘签到
        env:
          COOKIE_QUARK: ${{ secrets.COOKIE_QUARK }}
        run: python checkIn_Quark.py

      - name: 标记今天签到成功（写入文件）
        if: success()
        run: |
          date_str=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "$date_str" > .last_success_date
          echo "已记录今日签到成功：$date_str"

      - name: 保存签到标记到缓存
        if: success()
        uses: actions/cache@v4
        with:
          path: .last_success_date
          key: quark-sign-success-${{ github.run_date }}

      # 可选：微信推送通知（强烈推荐）
      - name: PushPlus 微信通知
        if: always()
        run: |
          status="成功✅"
          [ "${{ job.status }}" != "success" ] && status="失败❌（请检查 Cookie 是否过期）"
          curl -s "http://www.pushplus.plus/send" \
            -d "token=你的PushPlus_token" \
            -d "title=夸克网盘签到 ${status}" \
            -d "content=时间：$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')%0A触发方式：${{ github.event_name == 'workflow_dispatch' && '手动' || '自动' }}"

      # 清理旧记录（保留最近60条）
      - name: 清理旧的工作流记录
        uses: Mattraks/delete-workflow-runs@main
        if: always()
        with:
          token: ${{ github.token }}
          retain_days: 0
          keep_minimum_runs: 60
